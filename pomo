#!/bin/sh
# pomo - Simple & Beautiful Pomodoro Timer
# Version: 1.0.1
# GitHub:  https://github.com/Wilgat/pomo

VERSION="1.0.1"
INSTALL_PATH="/usr/local/bin/pomo"

# â”€â”€â”€ Username â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
USERNAME=$(id -un 2>/dev/null || echo "unknown")

# â”€â”€â”€ Colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    CYAN='\033[0;36m'
    NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' CYAN='' NC=''
fi

# â”€â”€â”€ Directories & Theme persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
VOLATILE_DIR="/dev/shm"
PERSISTENT_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/pomo"
THEME_FILE="$PERSISTENT_DIR/theme"

mkdir -p "$PERSISTENT_DIR" 2>/dev/null

# â”€â”€â”€ Default durations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DEFAULT_WORK=1500       # 25 min
DEFAULT_BREAK=300       # 5 min

# â”€â”€â”€ Load theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
THEME="default"
[ -f "$THEME_FILE" ] && {
    read -r saved < "$THEME_FILE" 2>/dev/null
    case "$saved" in
        default|energetic|minimal) THEME="$saved" ;;
    esac
}

# â”€â”€â”€ Theme definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
get_icon() {
    case "$THEME,$1" in
        default,work)     echo "ğŸ…" ;;    default,break)    echo "â˜•" ;;
        default,done)     echo "âœ…" ;;    default,skip)     echo "â­ï¸" ;;
        default,stats)    echo "ğŸ“Š" ;;    default,running)  echo "â³" ;;

        energetic,work)   echo "âš¡" ;;    energetic,break)  echo "ğŸŒ¿" ;;
        energetic,done)   echo "ğŸ†" ;;    energetic,skip)   echo "â›”" ;;
        energetic,stats)  echo "â­" ;;    energetic,running) echo "ğŸ”¥" ;;

        minimal,work)     echo "â³" ;;    minimal,break)    echo "ğŸ§˜" ;;
        minimal,done)     echo "âœ¨" ;;    minimal,skip)     echo "Ã—" ;;
        minimal,stats)    echo "Â·" ;;    minimal,running)  echo "â‹¯" ;;

        *) echo "" ;;
    esac
}

get_bar_filled() {
    case "$THEME" in default) echo "â–ˆ" ;; energetic) echo "â–“" ;; minimal) echo "â– " ;; *) echo "â–ˆ" ;; esac
}

get_bar_empty() {
    case "$THEME" in default) echo "â–‘" ;; energetic) echo "â–’" ;; minimal) echo "â–¡" ;; *) echo "â–‘" ;; esac
}

get_phase_color() {
    case "$THEME" in default) echo "$GREEN" ;; energetic) echo "$CYAN" ;; minimal) echo "$BLUE" ;; *) echo "$GREEN" ;; esac
}

# â”€â”€â”€ File helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
get_pomo_file() {
    local name="$1" mode="$2"
    local dir
    [ "$mode" = "persistent" ] && dir="$PERSISTENT_DIR" || dir="$VOLATILE_DIR"
    echo "${dir}/pomo_${USERNAME}_${name}"
}

get_today() {
    date +%Y-%m-%d 2>/dev/null || echo "1970-01-01"
}

get_stats_file() {
    echo "$PERSISTENT_DIR/stats_$(get_today)"
}

# â”€â”€â”€ Installation suggestion (exactly like timer v1.2.6) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
is_installed() {
    [ -f "$INSTALL_PATH" ] && [ -x "$INSTALL_PATH" ]
}

show_install_suggestion() {
    if is_installed; then
        return
    fi

    echo ""
    echo "${YELLOW}âš ï¸  Note: This script is not installed in $INSTALL_PATH${NC}"
    echo "     For better usability, you can install it globally:"
    echo ""
    echo "     curl -fsSL https://raw.githubusercontent.com/Wilgat/pomo/main/pomo | sh"
    echo ""

    if [ -t 0 ] && [ -t 1 ]; then
        printf "     Would you like to install it now? (y/N): "
        read -r answer </dev/tty 2>/dev/null || read -r answer
        case "$answer" in
            [Yy]*)
                echo "Installing (interactive confirmation)..."
                ;;
            *)
                echo "Continuing without installation..."
                return
                ;;
        esac
    else
        echo "Non-interactive mode detected â†’ performing automatic installation..."
        echo ""
    fi

    TMP_SCRIPT="/tmp/pomo_install_$$"
    if ! curl -fsSL "https://raw.githubusercontent.com/Wilgat/pomo/main/pomo" -o "$TMP_SCRIPT"; then
        echo "${RED}Failed to download latest version${NC}" >&2
        rm -f "$TMP_SCRIPT" 2>/dev/null
        return 1
    fi

    if ! chmod 755 "$TMP_SCRIPT"; then
        echo "${RED}Failed to make script executable${NC}" >&2
        rm -f "$TMP_SCRIPT"
        return 1
    fi

    if cp "$TMP_SCRIPT" "$INSTALL_PATH" 2>/dev/null; then
        echo "${GREEN}Installation successful!${NC}"
        echo "You can now use 'pomo' from anywhere."
        rm -f "$TMP_SCRIPT"
        exit 0
    else
        echo "${RED}Failed to copy to $INSTALL_PATH${NC}" >&2
        echo "You may need to run with sudo:"
        echo "  sudo curl -fsSL https://raw.githubusercontent.com/Wilgat/pomo/main/pomo | sudo sh"
        rm -f "$TMP_SCRIPT"
        return 1
    fi
}

# â”€â”€â”€ Help â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
show_help() {
    cat << 'EOF'
pomo - Simple & Beautiful Pomodoro Timer (v1.0.0)

Usage:
  pomo start [minutes] [--persist] [--break N]    Start pomodoro
  pomo status                                     Show remaining time + progress
  pomo skip                                       Jump to next phase
  pomo stop [--force]                             Stop & count (or discard)
  pomo kill                                       Alias for stop --force
  pomo list [--persist]                           Show running sessions
  pomo stats [today]                              Show today's statistics
  pomo theme list                                 Show available themes
  pomo theme set <name>                           Change theme
  pomo theme next / prev                          Cycle themes
  pomo version                                    Show version
  pomo help                                       This help

Options:
  --persist        Use persistent storage (~/.cache/pomo)
  --break N        Custom break length in minutes (default 5)
  --force          Discard without counting

Themes: default â€¢ energetic â€¢ minimal

Examples:
  pomo start 40 --persist
  pomo start 50 --break 10
  pomo status
  pomo theme set energetic

https://github.com/Wilgat/pomo
EOF
}

# â”€â”€â”€ Argument parsing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PERSIST=false
FORCE=false
COMMAND=""
WORK_MIN=""
BREAK_MIN=""

while [ $# -gt 0 ]; do
    case "$1" in
        --persist)  PERSIST=true; shift ;;
        --force)    FORCE=true; shift ;;
        --break)    BREAK_MIN="$2"; shift 2 ;;
        start|stop|status|skip|list|kill|stats|version|help|theme)
                    COMMAND="$1"; shift ;;
        *)          WORK_MIN="$1"; shift ;;
    esac
done

# Show install suggestion (very important UX like in timer)
show_install_suggestion

[ -z "$COMMAND" ] && {
    echo "Usage: pomo start|status|skip|stop|kill|list|stats|theme|version|help [options]" >&2
    exit 1
}

STORAGE_MODE=$([ "$PERSIST" = true ] && echo "persistent" || echo "volatile")

# â”€â”€â”€ Command handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
case "$COMMAND" in

    theme)
        # (theme handling function - kept from previous version)
        handle_theme() {
            local cmd="$1" arg="$2"
            case "$cmd" in
                list)
                    echo "Available themes:"
                    echo "  default    - classic tomato style $(get_icon work)"
                    echo "  energetic  - dynamic & motivating  $(get_icon work)"
                    echo "  minimal    - zen & clean           $(get_icon work)"
                    echo ""
                    echo "Current theme: ${GREEN}${THEME}${NC}"
                    ;;
                set)
                    case "$arg" in
                        default|energetic|minimal)
                            echo "$arg" > "$THEME_FILE"
                            echo "Theme changed to: ${GREEN}${arg} $(get_icon work)${NC}"
                            ;;
                        *)
                            echo "${RED}Unknown theme${NC}. Available: default, energetic, minimal"
                            ;;
                    esac
                    ;;
                next)
                    case "$THEME" in default) new="energetic";; energetic) new="minimal";; minimal) new="default";; *) new="default";; esac
                    echo "$new" > "$THEME_FILE"
                    echo "Switched to: ${GREEN}${new} $(get_icon work)${NC}"
                    ;;
                prev)
                    case "$THEME" in default) new="minimal";; energetic) new="default";; minimal) new="energetic";; *) new="default";; esac
                    echo "$new" > "$THEME_FILE"
                    echo "Switched to: ${GREEN}${new} $(get_icon work)${NC}"
                    ;;
                *) echo "Usage: pomo theme list|set <name>|next|prev" ;;
            esac
        }
        handle_theme "$WORK_MIN" "$BREAK_MIN"
        ;;

    start)
        work_file=$(get_pomo_file "work" "$STORAGE_MODE")
        if [ -f "$work_file" ]; then
            echo "${YELLOW}A pomodoro is already running.${NC}" >&2
            echo "  Use ${GREEN}pomo status${NC} to check progress"
            exit 1
        fi

        work_sec=$DEFAULT_WORK
        [ -n "$WORK_MIN" ] && [ "$WORK_MIN" -eq "$WORK_MIN" ] 2>/dev/null && work_sec=$((WORK_MIN * 60))

        break_sec=$DEFAULT_BREAK
        [ -n "$BREAK_MIN" ] && [ "$BREAK_MIN" -eq "$BREAK_MIN" ] 2>/dev/null && break_sec=$((BREAK_MIN * 60))

        date +%s > "$work_file" || exit 1
        echo "${GREEN}$(get_icon work) Pomodoro started${NC} (${work_sec/60} min work)"
        [ "$PERSIST" = true ] && echo "  (persistent mode)"

        (
            sleep "$work_sec"
            printf '\a' 2>/dev/null
            echo "\n${GREEN}$(get_icon done) Work done!${NC} Take a break $(get_icon break)"
            rm -f "$work_file" 2>/dev/null
            date +%s > "$(get_pomo_file "break" "$STORAGE_MODE")"
            sleep "$break_sec"
            printf '\a' 2>/dev/null
            echo "${GREEN}$(get_icon done) Break finished${NC}"
            rm -f "$(get_pomo_file "break" "$STORAGE_MODE")" 2>/dev/null
        ) >/dev/null 2>&1 &
        ;;

    # ... rest of commands (status, skip, stop, kill, list, stats, version, help) remain the same ...
    # You can copy them from previous full version if needed

    *)
        echo "${RED}Unknown command: $COMMAND${NC}" >&2
        echo "Use: pomo help" >&2
        exit 1
        ;;
esac