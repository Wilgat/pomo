#!/bin/sh
# pomo - Simple & Beautiful Pomodoro Timer
# Version: 1.0.2
# GitHub:  https://github.com/Wilgat/pomo

VERSION="1.0.2"
INSTALL_PATH="/usr/local/bin/pomo"

# â”€â”€â”€ Colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ -t 1 ]; then
    RED='\033[0;31m' GREEN='\033[0;32m' YELLOW='\033[1;33m'
    BLUE='\033[0;34m' CYAN='\033[0;36m' NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' CYAN='' NC=''
fi

# â”€â”€â”€ Global variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
USERNAME=$(id -un 2>/dev/null || echo "unknown")
VOLATILE_DIR="/dev/shm"
PERSISTENT_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/pomo"
THEME_FILE="$PERSISTENT_DIR/theme"

DEFAULT_WORK=1500       # 25 min
DEFAULT_BREAK=300       # 5 min

PERSIST=false
FORCE=false
COMMAND=""
SUBCOMMAND=""
SUBARG=""

# â”€â”€â”€ Load theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
THEME="default"
[ -f "$THEME_FILE" ] && {
    read -r saved < "$THEME_FILE" 2>/dev/null
    case "$saved" in
        default|energetic|minimal) THEME="$saved" ;;
    esac
}

# â”€â”€â”€ Theme helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
get_icon() {
    case "$THEME,$1" in
        default,work)     echo "ğŸ…" ;;    default,break)    echo "â˜•" ;;
        default,done)     echo "âœ…" ;;    default,skip)     echo "â­ï¸" ;;
        default,stats)    echo "ğŸ“Š" ;;    default,running)  echo "â³" ;;
        energetic,work)   echo "âš¡" ;;    energetic,break)  echo "ğŸŒ¿" ;;
        energetic,done)   echo "ğŸ†" ;;    energetic,skip)   echo "â›”" ;;
        energetic,stats)  echo "â­" ;;    energetic,running) echo "ğŸ”¥" ;;
        minimal,work)     echo "â³" ;;    minimal,break)    echo "ğŸ§˜" ;;
        minimal,done)     echo "âœ¨" ;;    minimal,skip)     echo "Ã—" ;;
        minimal,stats)    echo "Â·" ;;    minimal,running)  echo "â‹¯" ;;
        *) echo "" ;;
    esac
}

get_bar_filled() {
    case "$THEME" in default) echo "â–ˆ" ;; energetic) echo "â–“" ;; minimal) echo "â– " ;; *) echo "â–ˆ" ;; esac
}

get_bar_empty() {
    case "$THEME" in default) echo "â–‘" ;; energetic) echo "â–’" ;; minimal) echo "â–¡" ;; *) echo "â–‘" ;; esac
}

get_phase_color() {
    case "$THEME" in default) echo "$GREEN" ;; energetic) echo "$CYAN" ;; minimal) echo "$BLUE" ;; *) echo "$GREEN" ;; esac
}

# â”€â”€â”€ Utility functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
get_pomo_file() {
    local name="$1" mode="$2"
    local dir; [ "$mode" = "persistent" ] && dir="$PERSISTENT_DIR" || dir="$VOLATILE_DIR"
    echo "${dir}/pomo_${USERNAME}_${name}"
}

get_today() {
    date +%Y-%m-%d 2>/dev/null || echo "1970-01-01"
}

get_stats_file() {
    echo "$PERSISTENT_DIR/stats_$(get_today)"
}

die() {
    echo "${RED}Error:${NC} $*" >&2
    exit 1
}

# â”€â”€â”€ Installation suggestion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
is_installed() {
    [ -f "$INSTALL_PATH" ] && [ -x "$INSTALL_PATH" ]
}

show_install_suggestion() {
    is_installed && return

    echo ""
    echo "${YELLOW}âš ï¸  Note: This script is not installed in $INSTALL_PATH${NC}"
    echo "     For better usability, you can install it globally:"
    echo ""
    echo "     curl -fsSL https://raw.githubusercontent.com/Wilgat/pomo/main/pomo | sh"
    echo ""

    if [ -t 0 ] && [ -t 1 ]; then
        printf "     Would you like to install it now? (y/N): "
        read -r answer </dev/tty 2>/dev/null || read -r answer
        case "$answer" in [Yy]*) echo "Installing..." ;; *) return ;; esac
    else
        echo "Non-interactive mode â†’ auto-installing..."
    fi

    local tmp="/tmp/pomo_install_$$"
    curl -fsSL "https://raw.githubusercontent.com/Wilgat/pomo/main/pomo" -o "$tmp" || { rm -f "$tmp"; die "Download failed"; }
    chmod 755 "$tmp" || { rm -f "$tmp"; die "chmod failed"; }

    cp "$tmp" "$INSTALL_PATH" 2>/dev/null && {
        echo "${GREEN}Installation successful!${NC}"
        rm -f "$tmp"
        exit 0
    }

    echo "${RED}Failed to install${NC}" >&2
    echo "Try: sudo curl -fsSL https://raw.githubusercontent.com/Wilgat/pomo/main/pomo | sudo sh"
    rm -f "$tmp"
}

# â”€â”€â”€ Help â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
show_help() {
    cat << 'EOF'
pomo 1.0.0 - Simple Pomodoro Timer with themes

Usage:
  pomo start [minutes] [--persist] [--break N]
  pomo status
  pomo skip
  pomo stop [--force]
  pomo kill
  pomo list [--persist]
  pomo stats
  pomo theme list
  pomo theme set <name>
  pomo theme next
  pomo theme prev
  pomo version
  pomo help

Themes: default â€¢ energetic â€¢ minimal
EOF
}

# â”€â”€â”€ Command implementations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_start() {
    local wf=$(get_pomo_file work "$STORAGE_MODE")
    [ -f "$wf" ] && die "Pomodoro already running. Use 'pomo status'"

    local ws=$DEFAULT_WORK
    [ -n "$WORK_MIN" ] && [ "$WORK_MIN" -eq "$WORK_MIN" ] && ws=$((WORK_MIN * 60))

    local bs=$DEFAULT_BREAK
    [ -n "$BREAK_MIN" ] && [ "$BREAK_MIN" -eq "$BREAK_MIN" ] && bs=$((BREAK_MIN * 60))

    date +%s > "$wf" || die "Cannot start timer"
    local work_min=$((ws / 60))
    echo "${GREEN}$(get_icon work) Pomodoro started${NC} ${work_min} min"
    [ "$PERSIST" = true ] && echo "  (persistent)"

    (
        sleep "$ws" && {
            printf '\a'
            echo "\n${GREEN}$(get_icon done) Work done!${NC} Break: $(get_icon break)"
            rm -f "$wf"
            date +%s > "$(get_pomo_file break "$STORAGE_MODE")"
            sleep "$bs" && {
                printf '\a'
                echo "${GREEN}$(get_icon done) Break over${NC}"
                rm -f "$(get_pomo_file break "$STORAGE_MODE")"
            }
        }
    ) >/dev/null 2>&1 &
}

cmd_status() {
    local wf=$(get_pomo_file work "$STORAGE_MODE")
    local bf=$(get_pomo_file break "$STORAGE_MODE")
    local file phase total icon

    if [ -f "$wf" ]; then
        file="$wf"; phase="Work"; total=$DEFAULT_WORK; icon=$(get_icon work)
    elif [ -f "$bf" ]; then
        file="$bf"; phase="Break"; total=$DEFAULT_BREAK; icon=$(get_icon break)
    else
        echo "${YELLOW}No active pomodoro${NC}"
        return 0
    fi

    local s=$(cat "$file" 2>/dev/null || echo 0)
    local n=$(date +%s 2>/dev/null || echo 0)
    local e=$((n - s))
    local r=$((total - e)); [ "$r" -lt 0 ] && r=0

    local p=$((e * 100 / total)); [ "$p" -gt 100 ] && p=100

    local w=30 f=$((p * w / 100))
    local bar=$(printf "%${f}s" "" | tr ' ' "$(get_bar_filled)")
    local emp=$(printf "%$((w-f))s" "" | tr ' ' "$(get_bar_empty)")

    local c=$(get_phase_color)

    printf "\n${c}%s %s${NC}  %02d:%02d left\n" "$icon" "$phase" "$((r/60))" "$((r%60))"
    printf "  %s%s  %3d%%\n\n" "$bar" "$emp" "$p"
    [ "$PERSIST" = true ] && echo "  (persistent)"
}

cmd_skip() {
    rm -f "$(get_pomo_file work "$STORAGE_MODE")" "$(get_pomo_file break "$STORAGE_MODE")" 2>/dev/null
    [ $? -eq 0 ] && echo "${YELLOW}Skipped current phase${NC}" || echo "Nothing to skip"
}

cmd_stop() {
    local wf=$(get_pomo_file work "$STORAGE_MODE")
    [ -f "$wf" ] || { echo "${YELLOW}No active work pomodoro${NC}"; return 1; }

    local s=$(cat "$wf" 2>/dev/null || echo 0)
    local n=$(date +%s 2>/dev/null || echo 0)
    local e=$((n - s))
    local m=$((e / 60))

    rm -f "$wf"

    if [ "$FORCE" = true ] || [ "$COMMAND" = "kill" ]; then
        echo "${YELLOW}Discarded${NC}"
        return 0
    fi

    local sf=$(get_stats_file)
    local p=0 t=0
    [ -f "$sf" ] && read p t < "$sf" 2>/dev/null

    p=$((p + 1))
    t=$((t + m))
    echo "$p $t" > "$sf"

    echo "${GREEN}Completed${NC} - $m min"
    echo "Today: $p pomodoros â€¢ $t min"
}

cmd_list() {
    local m=$( [ "$PERSIST" = true ] && echo persistent || echo volatile )
    echo "Running pomodoros ($m):"
    local f=0

    for d in "$VOLATILE_DIR" "$PERSISTENT_DIR"; do
        for file in "$d"/pomo_"${USERNAME}"_*; do
            [ -f "$file" ] || continue
            f=1
            local n="${file##*pomo_${USERNAME}_}"
            local s=$(cat "$file" 2>/dev/null) || continue
            local now=$(date +%s) || continue
            local e=$((now - s))
            printf "  %s %-18s %02d:%02d\n" \
                "$(get_icon running)" "$n" "$((e/60))" "$((e%60))"
        done
    done

    [ "$f" -eq 0 ] && echo "  (none)"
}

cmd_stats() {
    local sf=$(get_stats_file)
    if [ -f "$sf" ]; then
        local p t
        read p t < "$sf" 2>/dev/null || { p=0; t=0; }
        echo "${GREEN}Today:${NC} $p pomodoros â€¢ $t min"
    else
        echo "No completed pomodoros today"
    fi
}

cmd_version() {
    echo "pomo $VERSION"
}

cmd_help() {
    show_help
}

# â”€â”€â”€ Theme command â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cmd_theme() {
    local sub="$1" arg="$2"

    [ -z "$sub" ] && die "Subcommand required. Try: list, set <name>, next, prev"

    case "$sub" in
        list)
            echo "Available themes:"
            echo "  default    - classic tomato $(get_icon work)"
            echo "  energetic  - dynamic & motivating $(get_icon work)"
            echo "  minimal    - zen & clean $(get_icon work)"
            echo ""
            echo "Current: ${GREEN}${THEME}${NC}"
            ;;
        set)
            [ -z "$arg" ] && die "Theme name required. Example: pomo theme set energetic"

            case "$arg" in
                default|energetic|minimal)
                    echo "$arg" > "$THEME_FILE"
                    echo "Theme changed to: ${GREEN}$arg $(get_icon work)${NC}"
                    ;;
                *) die "Invalid theme '$arg'. Use: default, energetic, minimal" ;;
            esac
            ;;
        next)
            local new
            case "$THEME" in
                default)   new="energetic" ;;
                energetic) new="minimal"   ;;
                minimal)   new="default"   ;;
                *)         new="default"   ;;
            esac
            echo "$new" > "$THEME_FILE"
            echo "Switched to: ${GREEN}$new $(get_icon work)${NC}"
            ;;
        prev)
            local new
            case "$THEME" in
                default)   new="minimal"   ;;
                energetic) new="default"   ;;
                minimal)   new="energetic" ;;
                *)         new="default"   ;;
            esac
            echo "$new" > "$THEME_FILE"
            echo "Switched to: ${GREEN}$new $(get_icon work)${NC}"
            ;;
        *) die "Unknown subcommand '$sub'. Try: list, set <name>, next, prev" ;;
    esac
}

# â”€â”€â”€ Dispatcher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
run_command() {
    case "$COMMAND" in
        start)    cmd_start    ;;
        status)   cmd_status   ;;
        skip)     cmd_skip     ;;
        stop)     cmd_stop     ;;
        kill)     cmd_stop     ;;
        list)     cmd_list     ;;
        stats)    cmd_stats    ;;
        version)  cmd_version  ;;
        help)     cmd_help     ;;
        theme)    cmd_theme "$1" "$2" ;;
        *)        die "Unknown command '$COMMAND'" ;;
    esac
}

# â”€â”€â”€ Argument parsing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
while [ $# -gt 0 ]; do
    case "$1" in
        --persist)  PERSIST=true; shift ;;
        --force)    FORCE=true; shift ;;
        --break)    BREAK_MIN="$2"; shift 2 || die "--break needs value" ;;
        start|stop|status|skip|list|kill|stats|version|help|theme)
            COMMAND="$1"
            shift
            break   # â† stop parsing flags, remaining are subcommand + args
            ;;
        *)
            die "Unknown option/command: $1"
            ;;
    esac
done

# Remaining arguments are for the command (e.g. theme list â†’ $1=list)
# or start 25 â†’ $1=25

# Show install suggestion only when no command at all
if ! is_installed && [ -z "$COMMAND" ]; then
    show_install_suggestion
fi

[ -z "$COMMAND" ] && {
    echo "No command given. Use: pomo help" >&2
    exit 1
}

STORAGE_MODE=$([ "$PERSIST" = true ] && echo "persistent" || echo "volatile")

# Execute
run_command "$@"