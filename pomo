#!/bin/sh
# pomo - Simple Pomodoro Timer with themes
# Version: 1.0.0
# GitHub:  https://github.com/Wilgat/pomo

VERSION="1.0.0"
INSTALL_PATH="/usr/local/bin/pomo"

# â”€â”€â”€ Colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ -t 1 ]; then
    RED='\033[0;31m'    GREEN='\033[0;32m'    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'   CYAN='\033[0;36m'     MAGENTA='\033[0;35m'
    NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' CYAN='' MAGENTA='' NC=''
fi

# â”€â”€â”€ Directories & Files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
VOLATILE_DIR="/dev/shm"
PERSISTENT_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/pomo"
THEME_FILE="$PERSISTENT_DIR/theme"

mkdir -p "$PERSISTENT_DIR" 2>/dev/null

# â”€â”€â”€ Default durations (seconds) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DEFAULT_WORK=1500       # 25 min
DEFAULT_BREAK=300       # 5 min
DEFAULT_LONG_BREAK=900  # 15 min (after 4 cycles - not implemented yet)

# â”€â”€â”€ Load Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
THEME="default"

[ -f "$THEME_FILE" ] && {
    read -r saved < "$THEME_FILE" 2>/dev/null
    case "$saved" in
        default|energetic|minimal) THEME="$saved" ;;
    esac
}

# â”€â”€â”€ Theme icons & styles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
get_icon() {
    case "$THEME,$1" in
        default,work)     echo "ðŸ…" ;;
        default,break)    echo "â˜•" ;;
        default,done)     echo "âœ…" ;;
        default,skip)     echo "â­ï¸" ;;
        default,stats)    echo "ðŸ“Š" ;;
        default,running)  echo "â³" ;;

        energetic,work)   echo "âš¡" ;;
        energetic,break)  echo "ðŸŒ¿" ;;
        energetic,done)   echo "ðŸ†" ;;
        energetic,skip)   echo "â›”" ;;
        energetic,stats)  echo "â­" ;;
        energetic,running) echo "ðŸ”¥" ;;

        minimal,work)     echo "â³" ;;
        minimal,break)    echo "ðŸ§˜" ;;
        minimal,done)     echo "âœ¨" ;;
        minimal,skip)     echo "Ã—" ;;
        minimal,stats)    echo "Â·" ;;
        minimal,running)  echo "â‹¯" ;;

        *) echo "" ;;
    esac
}

get_bar_filled() {
    case "$THEME" in
        default)   echo "â–ˆ" ;;
        energetic) echo "â–“" ;;
        minimal)   echo "â– " ;;
        *)         echo "â–ˆ" ;;
    esac
}

get_bar_empty() {
    case "$THEME" in
        default)   echo "â–‘" ;;
        energetic) echo "â–’" ;;
        minimal)   echo "â–¡" ;;
        *)         echo "â–‘" ;;
    esac
}

get_phase_color() {
    case "$THEME" in
        default)   echo "$GREEN" ;;
        energetic) echo "$CYAN"  ;;
        minimal)   echo "$BLUE"  ;;
        *)         echo "$GREEN" ;;
    esac
}

# â”€â”€â”€ Utility functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
get_pomo_file() {
    local name="$1" mode="$2"
    local dir
    [ "$mode" = "persistent" ] && dir="$PERSISTENT_DIR" || dir="$VOLATILE_DIR"
    echo "${dir}/pomo_${USERNAME}_${name}"
}

get_today() {
    date +%Y-%m-%d 2>/dev/null || echo "1970-01-01"
}

get_stats_file() {
    echo "$PERSISTENT_DIR/stats_$(get_today)"
}

# â”€â”€â”€ Theme management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
handle_theme() {
    local cmd="$1" arg="$2"

    case "$cmd" in
        list)
            printf "Available themes:\n"
            printf "  ${GREEN}default${NC}    - classic tomato style %s\n" "$(get_icon work)"
            printf "  ${CYAN}energetic${NC}  - dynamic & motivating  %s\n" "$(get_icon work)"
            printf "  ${BLUE}minimal${NC}    - zen & clean           %s\n" "$(get_icon work)"
            printf "\nCurrent: ${GREEN}%s${NC}\n" "$THEME"
            ;;
        set)
            case "$arg" in
                default|energetic|minimal)
                    echo "$arg" > "$THEME_FILE"
                    printf "${GREEN}Theme changed to: %s %s${NC}\n" "$arg" "$(get_icon work)"
                    ;;
                *)
                    printf "${RED}Unknown theme${NC}. Try: default, energetic, minimal\n"
                    ;;
            esac
            ;;
        next)
            case "$THEME" in
                default)   new="energetic" ;;
                energetic) new="minimal"   ;;
                minimal)   new="default"   ;;
                *)         new="default"   ;;
            esac
            echo "$new" > "$THEME_FILE"
            printf "Switched to: ${GREEN}%s %s${NC}\n" "$new" "$(get_icon work)"
            ;;
        prev)
            case "$THEME" in
                default)   new="minimal"   ;;
                energetic) new="default"   ;;
                minimal)   new="energetic" ;;
                *)         new="default"   ;;
            esac
            echo "$new" > "$THEME_FILE"
            printf "Switched to: ${GREEN}%s %s${NC}\n" "$new" "$(get_icon work)"
            ;;
        *)
            echo "Usage:"
            echo "  pomo theme list"
            echo "  pomo theme set <name>"
            echo "  pomo theme next"
            echo "  pomo theme prev"
            ;;
    esac
}

# â”€â”€â”€ Help â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
show_help() {
    cat << 'EOF'
pomo 1.0.0  -  Simple Pomodoro Timer with themes

Usage:
  pomo start [minutes] [--persist] [--break N]    Start pomodoro
  pomo status                                     Show remaining time + progress
  pomo skip                                       Jump to next phase
  pomo stop [--force]                             Stop & count (or discard)
  pomo kill                                       Alias: stop --force
  pomo list [--persist]                           Show running sessions
  pomo stats [today]                              Show statistics
  pomo theme list                                 Show available themes
  pomo theme set <name>                           Change theme
  pomo theme next / prev                          Cycle themes
  pomo version                                    Show version
  pomo help                                       This help

Options:
  --persist        Use persistent storage (~/.cache/pomo)
  --break N        Custom break length in minutes (default 5)
  --force          Discard without counting

Themes: default â€¢ energetic â€¢ minimal

https://github.com/Wilgat/pomo
EOF
}

# â”€â”€â”€ Argument parsing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PERSIST=false
FORCE=false
COMMAND=""
WORK_MIN=""
BREAK_MIN=""

while [ $# -gt 0 ]; do
    case "$1" in
        --persist)  PERSIST=true; shift ;;
        --force)    FORCE=true; shift ;;
        --break)    BREAK_MIN="$2"; shift 2 ;;
        start|stop|status|skip|list|kill|stats|version|help|theme)
                    COMMAND="$1"; shift ;;
        *)          WORK_MIN="$1"; shift ;;
    esac
done

USERNAME=$(id -un 2>/dev/null || echo "unknown")

# Very basic install suggestion (optional - can be removed)
[ ! -f "$INSTALL_PATH" ] && [ -t 1 ] && {
    echo "${YELLOW}Tip:${NC} Consider global install:"
    echo "  curl -fsSL https://raw.githubusercontent.com/Wilgat/pomo/main/pomo | sh"
    echo ""
}

[ -z "$COMMAND" ] && { echo "No command. Use: pomo help" >&2; exit 1; }

STORAGE_MODE=$([ "$PERSIST" = true ] && echo "persistent" || echo "volatile")

# â”€â”€â”€ Command dispatcher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
case "$COMMAND" in

    theme)  handle_theme "$WORK_MIN" "$BREAK_MIN"; exit 0 ;;

    start)
        work_file=$(get_pomo_file "work" "$STORAGE_MODE")
        break_file=$(get_pomo_file "break" "$STORAGE_MODE")

        if [ -f "$work_file" ] || [ -f "$break_file" ]; then
            echo "${YELLOW}Session already running.${NC}  Use 'pomo status'"
            exit 1
        fi

        work_sec=$DEFAULT_WORK
        [ -n "$WORK_MIN" ] && [ "$WORK_MIN" -eq "$WORK_MIN" ] 2>/dev/null && work_sec=$((WORK_MIN * 60))

        break_sec=$DEFAULT_BREAK
        [ -n "$BREAK_MIN" ] && [ "$BREAK_MIN" -eq "$BREAK_MIN" ] 2>/dev/null && break_sec=$((BREAK_MIN * 60))

        echo "$(get_icon work) ${GREEN}Pomodoro started${NC}  (${work_sec/60} min work)"
        [ "$PERSIST" = true ] && echo "  (persistent)"

        date +%s > "$work_file" || exit 1

        (
            sleep "$work_sec" && {
                printf '\a' 2>/dev/null
                echo "\n$(get_icon done) ${GREEN}Work done!${NC}  Take a break $(get_icon break)"
                rm -f "$work_file" 2>/dev/null
                date +%s > "$break_file" 2>/dev/null
                sleep "$break_sec" && {
                    printf '\a' 2>/dev/null
                    echo "$(get_icon done) ${GREEN}Break finished${NC}"
                    rm -f "$break_file" 2>/dev/null
                }
            }
        ) >/dev/null 2>&1 &
        ;;

    status)
        work_file=$(get_pomo_file "work" "$STORAGE_MODE")
        break_file=$(get_pomo_file "break" "$STORAGE_MODE")

        if [ -f "$work_file" ]; then
            file="$work_file"; phase="Work"; total=$DEFAULT_WORK; icon=$(get_icon work)
        elif [ -f "$break_file" ]; then
            file="$break_file"; phase="Break"; total=$DEFAULT_BREAK; icon=$(get_icon break)
        else
            echo "${YELLOW}No active pomodoro.${NC}"
            exit 0
        fi

        start=$(cat "$file" 2>/dev/null || echo 0)
        now=$(date +%s 2>/dev/null || echo 0)
        elapsed=$((now - start))
        remaining=$((total - elapsed))
        [ "$remaining" -lt 0 ] && remaining=0

        percent=$((elapsed * 100 / total))
        [ "$percent" -gt 100 ] && percent=100

        width=30
        filled=$((percent * width / 100))
        fill_char=$(get_bar_filled)
        empty_char=$(get_bar_empty)

        bar=$(printf "%${filled}s" "" | tr ' ' "$fill_char")
        empty=$(printf "%$((width - filled))s" "" | tr ' ' "$empty_char")

        phase_color=$(get_phase_color)

        printf "\n${phase_color}%s %s phase${NC}   %02d:%02d remaining\n" "$icon" "$phase" "$((remaining/60))" "$((remaining%60))"
        printf "  %s%s  %3d%%\n\n" "$bar" "$empty" "$percent"
        [ "$PERSIST" = true ] && echo "  (persistent)"
        ;;

    skip)
        work_file=$(get_pomo_file "work" "$STORAGE_MODE")
        break_file=$(get_pomo_file "break" "$STORAGE_MODE")
        if [ -f "$work_file" ] || [ -f "$break_file" ]; then
            rm -f "$work_file" "$break_file" 2>/dev/null
            echo "$(get_icon skip) ${YELLOW}Current phase skipped${NC}"
        else
            echo "${YELLOW}Nothing to skip.${NC}"
        fi
        ;;

    stop)
        work_file=$(get_pomo_file "work" "$STORAGE_MODE")
        [ -f "$work_file" ] || { echo "${YELLOW}No active work session.${NC}"; exit 1; }

        start=$(cat "$work_file" 2>/dev/null || echo 0)
        now=$(date +%s 2>/dev/null || echo 0)
        elapsed=$((now - start))
        minutes=$((elapsed / 60))

        rm -f "$work_file" 2>/dev/null

        if [ "$FORCE" = true ]; then
            echo "$(get_icon skip) ${YELLOW}Session discarded (not counted)${NC}"
        else
            stats_file=$(get_stats_file)
            if [ -f "$stats_file" ]; then
                read pomos mins < "$stats_file" 2>/dev/null || { pomos=0; mins=0; }
            else
                pomos=0 mins=0
            fi
            pomos=$((pomos + 1))
            mins=$((mins + minutes))
            echo "$pomos $mins" > "$stats_file"

            echo "$(get_icon done) ${GREEN}Pomodoro completed${NC}  ${minutes} min"
            echo "  Today: ${GREEN}${pomos} pomodoros${NC} â€¢ ${mins} min"
        fi
        ;;

    kill)   exec "$0" stop --force ;;

    list)
        mode=$([ "$PERSIST" = true ] && echo "persistent" || echo "volatile")
        echo "Running pomodoros (${mode}):"

        found=0

        # Volatile first
        for f in "${VOLATILE_DIR}"/pomo_"${USERNAME}"_*; do
            [ -f "$f" ] || continue
            found=1
            name="${f##*pomo_${USERNAME}_}"
            start=$(cat "$f" 2>/dev/null) || continue
            now=$(date +%s 2>/dev/null) || continue
            elapsed=$((now - start))
            printf "  %s  %-18s  %02d:%02d\n" \
                "$(get_icon running)" "$name" "$((elapsed/60))" "$((elapsed%60))"
        done

        # Persistent second
        for f in "${PERSISTENT_DIR}"/pomo_"${USERNAME}"_*; do
            [ -f "$f" ] || continue
            found=1
            name="${f##*pomo_${USERNAME}_}"
            start=$(cat "$f" 2>/dev/null) || continue
            now=$(date +%s 2>/dev/null) || continue
            elapsed=$((now - start))
            printf "  %s  %-18s  %02d:%02d\n" \
                "$(get_icon running)" "$name" "$((elapsed/60))" "$((elapsed%60))"
        done

        [ "$found" -eq 0 ] && echo "  (none)"
        ;;

    stats)
        period="${WORK_MIN:-today}"
        case "$period" in
            today)
                stats_file=$(get_stats_file)
                if [ -f "$stats_file" ]; then
                    read pomos mins < "$stats_file" 2>/dev/null || { pomos=0; mins=0; }
                    echo "$(get_icon stats) Today: ${GREEN}${pomos} pomodoros${NC} â€¢ ${mins} min focus"
                else
                    echo "Today: no completed pomodoros yet"
                fi
                ;;
            *)
                echo "${YELLOW}Only 'today' supported in this version${NC}"
                ;;
        esac
        ;;

    version) echo "pomo ${VERSION}" ;;
    help)    show_help ;;

    *)
        echo "${RED}Unknown command:${NC} $COMMAND"
        echo "Try: pomo help"
        exit 1
        ;;
esac